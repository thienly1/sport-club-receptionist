# =============================================================================
# CD Pipeline - Sport Club AI Receptionist
# =============================================================================
# This workflow handles deployment to staging and production environments
# after CI passes on the main branch.

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.11"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHONPATH: ${{ github.workspace }}/backend/src

# Give github permissions to read contents and write packages
permissions:
  contents: read
  packages: write

jobs:
  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest

    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.yourapp.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # -----------------------------------------------------------------------
      # Option 1: Deploy to Railway/Render/Fly.io (PaaS)
      # -----------------------------------------------------------------------
      # Uncomment the appropriate section for your hosting provider

      # --- Railway ---
      # - name: Install Railway CLI
      #   run: npm install -g @railway/cli
      #
      # - name: Deploy to Railway
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      #   run: railway up --service sport-club-api --environment staging

      # --- Render ---
      # - name: Deploy to Render
      #   env:
      #     RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      #     RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_STAGING }}
      #   run: |
      #     curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
      #       -H "Authorization: Bearer $RENDER_API_KEY"

      # --- Fly.io ---
      # - name: Setup Fly.io
      #   uses: superfly/flyctl-actions/setup-flyctl@master
      #
      # - name: Deploy to Fly.io
      #   env:
      #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      #   run: flyctl deploy --config fly.staging.toml

      # -----------------------------------------------------------------------
      # Option 2: Deploy Docker to Container Registry + Cloud Run/ECS
      # -----------------------------------------------------------------------

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Permissions
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Token length: ${#GITHUB_TOKEN}"
          echo "Event: ${{ github.event_name }}"

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                context: ./backend
                push: true
                tags: |
                  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging
                  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # --- Google Cloud Run ---
      # - name: Deploy to Cloud Run
      #   uses: google-github-actions/deploy-cloudrun@v2
      #   with:
      #     service: sport-club-api-staging
      #     region: europe-north1
      #     image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deployment notification
        run: |
          echo "üöÄ Deployed to staging environment"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

  # ===========================================================================
  # Deploy to Production
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://api.yourapp.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Debug Permissions
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Token length: ${#GITHUB_TOKEN}"
          echo "Event: ${{ github.event_name }}"
      - name: Tag image for production
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      # --- Deploy to production infrastructure ---
      # Add your production deployment steps here

      - name: Production deployment notification
        run: |
          echo "üéâ Deployed to production environment"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production"

  # ===========================================================================
  # Database Migration Job
  # ===========================================================================
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: staging
    if: |
      (github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          PYTHONPATH: ${{ github.workspace }}/backend/src
        run: |
          cd backend
          # Debug check
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå DATABASE_URL is empty - secret may not be set!"
            exit 1
          fi
          echo "‚úÖ DATABASE_URL is set (${#DATABASE_URL} characters)"
          alembic upgrade head
